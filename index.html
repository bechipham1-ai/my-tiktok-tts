<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin TikTok TTS - Idol B√®o (Full Version)</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --main: #fe2c55; --bg: #121212; --panel: #1e1e1e; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
        
        .column { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; }
        .left { flex: 2; border-color: var(--main); }
        .right { flex: 1.5; }
        
        input, button { padding: 12px; margin: 5px 0; border-radius: 8px; border: none; box-sizing: border-box; }
        button { background: var(--main); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; }

        /* Tab Menu */
        .tab-menu { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { background: #333; flex: 1; padding: 8px; font-size: 13px; }
        .tab-active { background: var(--main); }
        
        #chat, .list-box { flex-grow: 1; overflow-y: auto; background: #000; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #222; }
        
        /* Message Style */
        .msg { font-size: 14px; border-bottom: 1px solid #222; padding: 8px 0; }
        .msg-processed { font-size: 12px; color: #888; font-style: italic; margin-top: 3px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #222; font-size: 13px; }
        .del { color: #ff4d4d; cursor: pointer; font-size: 11px; border: 1px solid #ff4d4d; padding: 2px 5px; border-radius: 4px; }

        /* Switch UI */
        .setting-row { display: flex; align-items: center; justify-content: space-between; background: #000; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid #333; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--main); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <div class="column left">
        <h3 style="color:var(--main); margin:0 0 10px 0;">TIKTOK LIVE CONTROL</h3>
        <input type="text" id="user" placeholder="Nh·∫≠p ID TikTok...">
        <button onclick="start()">K·∫æT N·ªêI H·ªÜ TH·ªêNG</button>
        
        <div class="setting-row">
            <span>üîä Ch√†o ng∆∞·ªùi m·ªõi v√†o ph√≤ng:</span>
            <label class="switch">
                <input type="checkbox" id="welcomeToggle" checked>
                <span class="slider"></span>
            </label>
        </div>

        <p id="stt" style="color:#00f2ea; font-size:13px; font-weight:bold;">Tr·∫°ng th√°i: S·∫µn s√†ng</p>
        
        <div id="chat"></div>
    </div>

    <div class="column right">
        <div class="tab-menu">
            <button class="tab-btn tab-active" id="btn-ban" onclick="switchTab('ban')">T·ª™ C·∫§M (CH·∫∂N)</button>
            <button class="tab-btn" id="btn-acr" onclick="switchTab('acr')">VI·∫æT T·∫ÆT (D·ªäCH)</button>
        </div>

        <div id="tab-ban-ui">
            <input type="text" id="new-word" placeholder="Nh·∫≠p t·ª´ mu·ªën ch·∫∑n...">
            <button onclick="addWord()" style="background:#444;">TH√äM V√ÄO DANH S√ÅCH CH·∫∂N</button>
            <div class="list-box" id="word-list"></div>
        </div>

        <div id="tab-acr-ui" style="display:none;">
            <div style="display: flex; gap: 5px;">
                <input type="text" id="acr-key" placeholder="Vi·∫øt t·∫Øt (vd: dag)" style="flex:1">
                <input type="text" id="acr-val" placeholder="D·ªãch ra (vd: ƒëang)" style="flex:2">
            </div>
            <button onclick="addAcr()" style="background:#444;">C·∫¨P NH·∫¨T T·ª™ ƒêI·ªÇN</button>
            <div class="list-box" id="acr-list"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let queue = [], playing = false;
        
        // √Çm thanh hi·ªáu ·ª©ng Ting Ting
        const ting = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");

        function switchTab(t) {
            document.getElementById('tab-ban-ui').style.display = t === 'ban' ? 'block' : 'none';
            document.getElementById('tab-acr-ui').style.display = t === 'acr' ? 'block' : 'none';
            document.getElementById('btn-ban').className = 'tab-btn' + (t === 'ban' ? ' tab-active' : '');
            document.getElementById('btn-acr').className = 'tab-btn' + (t === 'acr' ? ' tab-active' : '');
        }

        // --- LOGIC DATABASE ---
        async function loadAcronyms() {
            const res = await fetch('/api/acronyms');
            const data = await res.json();
            document.getElementById('acr-list').innerHTML = data.map(a => `
                <div class="item"><span><b>${a.key}</b> ‚ûî ${a.value}</span> <span class="del" onclick="delAcr('${a.key}')">X√ìA</span></div>
            `).join('');
        }
        async function addAcr() {
            const key = document.getElementById('acr-key').value.trim();
            const value = document.getElementById('acr-val').value.trim();
            if(!key || !value) return;
            await fetch('/api/acronyms', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({key, value}) });
            document.getElementById('acr-key').value = ''; document.getElementById('acr-val').value = '';
            loadAcronyms();
        }
        async function delAcr(key) {
            await fetch(`/api/acronyms/${encodeURIComponent(key)}`, { method: 'DELETE' });
            loadAcronyms();
        }

        async function loadWords() {
            const res = await fetch('/api/words');
            const data = await res.json();
            document.getElementById('word-list').innerHTML = data.map(w => `
                <div class="item"><span>${w}</span> <span class="del" onclick="delWord('${w}')">X√ìA</span></div>
            `).join('');
        }
        async function addWord() {
            const word = document.getElementById('new-word').value.trim();
            if(!word) return;
            await fetch('/api/words', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({word}) });
            document.getElementById('new-word').value = '';
            loadWords();
        }
        async function delWord(word) {
            await fetch(`/api/words/${encodeURIComponent(word)}`, { method: 'DELETE' });
            loadWords();
        }

        // --- LOGIC TIKTOK ---
        function start() {
            const user = document.getElementById('user').value.trim();
            if(!user) return alert("Nh·∫≠p ID!");
            socket.emit('set-username', user);
            document.getElementById('stt').innerText = "ƒêang k·∫øt n·ªëi...";
            queue = [];
        }

        socket.on('status', m => document.getElementById('stt').innerText = m);

        socket.on('audio-data', d => {
            const isWelcomeOn = document.getElementById('welcomeToggle').checked;
            
            // Hi·ªÉn th·ªã chat
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'msg';
            
            let nameColor = "#fe2c55";
            let msgColor = "white";
            if(d.type === 'welcome') msgColor = "#00f2ea";
            
            div.innerHTML = `<b style="color:${nameColor}">${d.user}:</b> <span style="color:${msgColor}">${d.comment}</span>`;
            if(d.processed && d.processed !== d.comment) {
                div.innerHTML += `<div class="msg-processed">‚ûú D·ªãch: ${d.processed}</div>`;
            }
            
            chat.prepend(div);
            if (chat.children.length > 50) chat.removeChild(chat.lastChild);

            // X·ª≠ l√Ω √¢m thanh
            if (d.audio) {
                // N·∫øu l√† ch√†o m√† ƒëang t·∫Øt n√∫t g·∫°t th√¨ b·ªè qua
                if (d.type === 'welcome' && !isWelcomeOn) return;
                
                // N·∫øu l√† ch√†o th√¨ th√™m ti·∫øng Ting v√†o h√†ng ƒë·ª£i
                if (d.type === 'welcome') {
                    queue.push('TING');
                }
                
                queue.push(d.audio);
                if (!playing) play();
            }
        });

        function play() {
            if (!queue.length) { playing = false; return; }
            playing = true;
            const item = queue.shift();

            if (item === 'TING') {
                ting.play().then(() => {
                    ting.onended = () => play();
                }).catch(() => play());
            } else {
                const a = new Audio(item);
                a.onended = () => setTimeout(play, 300);
                a.onerror = () => { playing = false; play(); };
                a.play().catch(() => { playing = false; play(); });
            }
        }

        // Kh·ªüi t·∫°o
        loadWords();
        loadAcronyms();
    </script>
</body>
</html>
